<html>

<head>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
   <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css'>
   <meta charset="utf-8">
   <title>Thêm bài viết mới v2</title>

</head>

<body>
   <hr>
   <div>
      <section class="grid extended-grid-18">
         <div class="container clearfix">
            <div class="row row-sm-sm sample-row">
               <div class="col-xs-12 col-md-8 gutter-sm-sm gutter-margin-xs-sm">
                  <div class="inner">
                     <form id="contact-form" class="form-horizontal" role="form">

                        <div class="form-group">
                           <div class="col-sm-12">
                              <h4>Tiêu đề</h4>
                              <input type="text" class="form-control" id="titleId" placeholder="Tiêu đề"
                                 name="Tiêu đề mới" value="" required>
                           </div>
                        </div>

                        <div class="form-group">
                           <div class="col-sm-12">
                              <h4>Tác giả</h4>

                              <select id="authorId" name="author-name" class="form-control" required>
                                 <option value="john">Nhâm Ngọc Tần</option>
                                 <option value="sal">Anh Hàng Xóm</option>
                                 <option value="minh">Quả táo tàu</option>
                              </select>
                           </div>
                        </div>
                        <div class="form-group">
                           <div class="col-sm-12">
                              <h4>Chủ đề</h4>
                              <input type="text" class="form-control" id="categorieIds"
                                 placeholder="vd: nhiếp ảnh, lập trình" name="category-name" value="" required>
                           </div>
                        </div>
                        <div class="form-group">
                           <div class="col-sm-12">
                              <h4>Thẻ tag</h4>
                              <input type="text" class="form-control" id="tagIds"
                                 placeholder="vd: nhiếp ảnh, lập trình" name="tag-name" value="" required>
                           </div>
                        </div>
                        <div class="form-group">
                           <div class="col-sm-12">
                              <h4>Ngày xuất bản</h4>
                              <input type="date" class="form-control" id="dateId" name="date-name" required>
                           </div>
                        </div>
                        <div class="form-group">
                           <div class="col-sm-12">
                              <h4>Tóm tắt</h4>
                              <input type="text" class="form-control" value="" rows="10" placeholder="Tóm tắt"
                                 name="description-name" id="descriptionId" required>
                           </div>
                        </div>
                        <br>
                     </form>


                     <div class="form-group">
                        <div class="col-sm-12">
                           <h4>Nội dung</h4>
                           <input id="editor" class="form-control" value="" rows="10" placeholder="Nội dung"
                              name="ck-name" required>
                        </div>
                     </div>
                     <div class="form-group">
                        <div class="col-sm-12">
                           <label for="myCheck">Cho phép bình luận:</label>
                           <input type="checkbox" id="myCheck" onclick="myFunction()">
                        </div>
                     </div>

                     <button onclick="saveDynamicDataToFile();" class="btn btn-primary send-button" id="submit"
                        type="submit" value="SEND">
                        <div class="alt-send-button">
                           <i class="fa fa-paper-plane"></i><span class="send-text">Click to Save</span>
                        </div>
                     </button>
                  </div>
               </div>
               <div class="col-xs-6 col-md-4 gutter-sm-sm gutter-margin-xs-sm">
                  <div class="inner">

                     <h2>Mã code markdown</h2>
                     <hr>
                     <div id="myText"></div>
                     <p>Ctrl+A và Ctrl+S để lưu code markdown. Bạn thử dùng Ctrl+V để dán nội dung đã copy vào file md
                        của bạn.</p>
                     <hr>
                  </div>
               </div>
            </div>
         </div>
      </section>
   </div>

</body>

<script src="../ckeditor5/build/ckeditor.js"></script>
<script src="../assets/js/FileSaver.js"></script>
<script>

   let isComment = false;
   let titleValue = "";
   let authorValue = "";
   let categoryValue = "";
   let tagValue = "";
   let theEditor = "";
   let headContent = "";
   let dateValue = "";
   let descriptionValue = "";
   function checkInputTitleId(obj) {
      if (obj && obj.value) {
         titleValue = obj.value;
         console.log("title: ", titleValue);
         checkChangeForm();
      }
   }

   function checkChangeForm() {
      if (document.getElementById('titleId') && document.getElementById('titleId').value) {
         titleValue = document.getElementById('titleId').value
         titleValue = titleValue.trim()
      }
      if (document.getElementById('authorId') && document.getElementById('authorId').value) {
         authorValue = document.getElementById('authorId').value
         authorValue = authorValue.trim()
      }
      if (document.getElementById('categorieIds') && document.getElementById('categorieIds').value) {
         categoryValue = document.getElementById('categorieIds').value
         categoryValue = categoryValue.trim()
      }
      if (document.getElementById('tagIds') && document.getElementById('tagIds').value) {
         tagValue = document.getElementById('tagIds').value
         tagValue = tagValue.trim()
      }
      if (document.getElementById('dateId') && document.getElementById('dateId').value) {
         dateValue = (document.getElementById('dateId').value).toString()
      }
      if (document.getElementById('descriptionId') && document.getElementById('descriptionId').value) {
         descriptionValue = (document.getElementById('descriptionId').value).toString()
         descriptionValue = descriptionValue.trim()
      }

   }
   document.querySelector("form").addEventListener("change", (event) => {
      if (!event.target.classList.contains("nochange")) {
         console.log("fire change for me");
         checkChangeForm();
         headContent = "---\n"
         if (titleValue) {
            headContent = [headContent, "title: ", '"', titleValue, '"', "\n"].join('');
            // headContent = headContent + "title: " + '"' + titleValue + '"' + "\n";
         }
         if (authorValue) {
            headContent = [headContent, "author: ", authorValue, "\n"].join('');
            // headContent = headContent + "author: " + authorValue + "\n";
         }
         if (descriptionValue) {
            headContent = [headContent, "description: ", '"', descriptionValue, '"', "\n", "excerpt: ", '"', descriptionValue, '"', "\n"].join('');
            // headContent = headContent + "description: " + '"' + descriptionValue + '"' + "\n";
            // excerpt
         }
         if (categoryValue) {
            // headContent = headContent + 'categories: ' + '[' + categoryValue + ' ]\n';
            headContent = [headContent, 'categories: ', '[ ', categoryValue, ' ]\n'].join('');
         }
         if (tagValue) {
            // headContent = headContent + 'tags: ' + '[' + tagValue + ' ]\n';
            headContent = [headContent, 'tags: ', '[ ', tagValue, ' ]\n'].join('');
         }
         if (dateValue) {
            headContent = [headContent, 'date: ', '"', dateValue, '"', '\n'].join('');
            // headContent = headContent + 'date: ' + '"' + dateValue + '"' + '\n';
         }
         // headContent = headContent + "lazyimages: " + '"' + "enabled" + '"' + "\n";
         headContent = [headContent, "lazyimages: ", '"', "enabled", '"', "\n", "layout: post\n", "isGithubComments: ", isComment, "\n", "---\n\n"].join('')
         // headContent = headContent + "layout: " + "post" + "\n";
         // headContent = headContent + "isGithubComments: " + isComment + "\n";
         // headContent = headContent + "---\n\n";
         if (headContent) {
            document.getElementById('myText').innerHTML = ["<pre>", headContent, theEditor, "</pre>"].join('');
         }
      } else {
         console.log("no change event for me");
      }
   });

   function checkInputCategoryIds(obj) {
      if (obj && obj.value) {
         categoryValue = obj.value;
         checkChangeForm();
      }
   }
   function checkInputTagIds(obj) {
      if (obj && obj.value) {
         tagValue = obj.value;
         checkChangeForm();
      }
   }
   function checkInputAuthorId(obj) {
      if (obj && obj.value) {
         authorValue = obj.value;
         checkChangeForm();
      }
   }


   ClassicEditor
      .create(document.querySelector('#editor')).then(editor => {
         console.log('Editor was initialized', editor);
         editor.model.document.on('change:data', () => {
            console.log(editor.getData());
            theEditor = editor.getData();

            if (headContent) {
               document.getElementById('myText').innerHTML = "<pre>" + headContent + editor.getData() + "</pre>";
            } else {
               document.getElementById('myText').innerHTML = "<pre>" + editor.getData() + "</pre>";
            }

            // marked.parse(editor.getData());

         });
      })
      .catch(error => {
         console.error(error);
      });

   async function saveDynamicDataToFile() {
      if (headContent) {
         let nameFile = ""
         let blob = new Blob([[headContent, theEditor].join('')], { type: "text/plain;charset=utf-8" });

         if (!dateValue) {
            const d = new Date()
            let year = d.getFullYear();
            let month = d.getMonth() + 1;
            let day = d.getDate();
            dateValue = year + "-" + month + "-" + day
         }
         titleValue = titleValue.trim()
         titleValue = removeAccents(titleValue);
         titleValue = titleValue.replace(/\s/g, '-')
         titleValue = titleValue.toLowerCase()
         nameFile = dateValue + "-" + titleValue + ".md"
         saveAs(blob, nameFile);
      } else {
         alert('Rỗng');
      }

   }
   function removeAccents(str) {
      var AccentsMap = [
         "aàảãáạăằẳẵắặâầẩẫấậ",
         "AÀẢÃÁẠĂẰẲẴẮẶÂẦẨẪẤẬ",
         "dđ", "DĐ",
         "eèẻẽéẹêềểễếệ",
         "EÈẺẼÉẸÊỀỂỄẾỆ",
         "iìỉĩíị",
         "IÌỈĨÍỊ",
         "oòỏõóọôồổỗốộơờởỡớợ",
         "OÒỎÕÓỌÔỒỔỖỐỘƠỜỞỠỚỢ",
         "uùủũúụưừửữứự",
         "UÙỦŨÚỤƯỪỬỮỨỰ",
         "yỳỷỹýỵ",
         "YỲỶỸÝỴ"
      ];
      for (var i = 0; i < AccentsMap.length; i++) {
         var re = new RegExp('[' + AccentsMap[i].substr(1) + ']', 'g');
         var char = AccentsMap[i][0];
         str = str.replace(re, char);
      }
      return str;
   }

   function myFunction() {
      var checkBox = document.getElementById("myCheck");
      if (checkBox.checked == true) {
         isComment = true;
      } else {
         isComment = false;
      }
   }

</script>


</html>
